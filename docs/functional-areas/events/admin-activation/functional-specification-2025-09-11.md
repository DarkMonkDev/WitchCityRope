# Functional Specification: Admin Dashboard Events Management System Activation
<!-- Last Updated: 2025-09-11 -->
<!-- Version: 1.0 -->
<!-- Owner: Functional Spec Agent -->
<!-- Status: Ready for Implementation -->

## Technical Overview

This functional specification details the **MINIMAL IMPLEMENTATION** required to activate the existing Admin Dashboard Events Management system. The focus is on connecting existing assets rather than building new ones - we have a sophisticated AdminEventsPage component, working GET endpoints, and established architecture that just needs to be wired together.

**Key Insight**: This is an ACTIVATION project, not a development project. 85% of the code already exists.

## Architecture

### Microservices Architecture
**CRITICAL**: This is a React + .NET API microservices architecture:
- **Web Service** (React + Vite): UI/Auth at http://localhost:5173
- **API Service** (Minimal API): Business logic at http://localhost:5655
- **Database** (PostgreSQL): localhost:5433
- **Pattern**: React → HTTP → API → Database (NEVER React → Database directly)

### Component Structure (Existing Assets)
```
✅ EXISTING:
/apps/web/src/pages/admin/AdminEventsPage.tsx (568 lines - complete)
/apps/web/src/components/events/EventForm.tsx (complex form with modals)
/apps/web/src/features/events/api/queries.ts (TanStack Query integration)
/apps/web/src/features/events/api/mutations.ts (CRUD mutations ready)
/src/WitchCityRope.Api/Features/Events/Services/EventsManagementService.cs (partial)

❌ MISSING FOR ACTIVATION:
/apps/web/src/pages/admin/AdminDashboardPage.tsx (simple dashboard)
/src/WitchCityRope.Api/Features/Events/Endpoints/* (POST/PUT/DELETE endpoints)
/src/WitchCityRope.Core/Entities/EventSession.cs (Event Session Matrix entities)
```

### Service Architecture (Already Established)
- **Web Service**: React components make HTTP calls to API via TanStack Query
- **API Service**: .NET Minimal API with Entity Framework Core database access
- **No Direct Database Access**: React NEVER directly accesses database

## Data Models

### Database Schema (Event Session Matrix - TO IMPLEMENT)
```sql
-- Core Events table (EXISTS)
CREATE TABLE Events (
    Id UUID PRIMARY KEY,
    Title VARCHAR(200) NOT NULL,
    Description TEXT,
    StartDate TIMESTAMPTZ NOT NULL,
    EndDate TIMESTAMPTZ NOT NULL,
    CreatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- NEW: Event Sessions table
CREATE TABLE EventSessions (
    Id UUID PRIMARY KEY,
    EventId UUID NOT NULL REFERENCES Events(Id) ON DELETE CASCADE,
    SessionNumber INTEGER NOT NULL, -- 1, 2, 3 for S1, S2, S3
    Name VARCHAR(100) NOT NULL,
    StartDateTime TIMESTAMPTZ NOT NULL,
    EndDateTime TIMESTAMPTZ NOT NULL,
    Capacity INTEGER NOT NULL CHECK (Capacity > 0),
    CreatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- NEW: Event Ticket Types table
CREATE TABLE EventTicketTypes (
    Id UUID PRIMARY KEY,
    EventId UUID NOT NULL REFERENCES Events(Id) ON DELETE CASCADE,
    Name VARCHAR(100) NOT NULL,
    Type VARCHAR(20) NOT NULL CHECK (Type IN ('Single', 'Couples')),
    MinPrice DECIMAL(10,2) NOT NULL,
    MaxPrice DECIMAL(10,2) NOT NULL,
    Quantity INTEGER NOT NULL,
    SalesEndDate DATE NOT NULL,
    IsActive BOOLEAN NOT NULL DEFAULT TRUE,
    CreatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- NEW: Session inclusions for ticket types
CREATE TABLE TicketTypeSessionInclusions (
    Id UUID PRIMARY KEY,
    TicketTypeId UUID NOT NULL REFERENCES EventTicketTypes(Id) ON DELETE CASCADE,
    SessionId UUID NOT NULL REFERENCES EventSessions(Id) ON DELETE CASCADE,
    UNIQUE(TicketTypeId, SessionId)
);
```

### DTOs and ViewModels (EXISTS via NSwag Generation)
```csharp
// EXISTING: Generated by NSwag from API
public class EventDto
{
    public Guid Id { get; set; }
    public string Title { get; set; }
    public string Description { get; set; }
    public DateTime StartDateTime { get; set; }
    public DateTime EndDateTime { get; set; }
    // Additional properties as needed
}

// TO IMPLEMENT: Event Session Matrix DTOs
public class EventSessionDto
{
    public Guid Id { get; set; }
    public Guid EventId { get; set; }
    public int SessionNumber { get; set; }
    public string Name { get; set; }
    public DateTime StartDateTime { get; set; }
    public DateTime EndDateTime { get; set; }
    public int Capacity { get; set; }
}

public class EventTicketTypeDto
{
    public Guid Id { get; set; }
    public Guid EventId { get; set; }
    public string Name { get; set; }
    public string Type { get; set; } // 'Single' | 'Couples'
    public decimal MinPrice { get; set; }
    public decimal MaxPrice { get; set; }
    public int Quantity { get; set; }
    public DateTime SalesEndDate { get; set; }
    public List<Guid> SessionIds { get; set; }
}
```

## API Specifications

### Existing Endpoints (WORKING ✅)
| Method | Path | Description | Status |
|--------|------|-------------|--------|
| GET | /api/events-management | List published events | ✅ Working |
| GET | /api/events/{id} | Get event details | ✅ Working |
| GET | /api/events/{id}/availability | Get availability | ✅ Working |

### Missing Endpoints (TO IMPLEMENT ❌)
| Method | Path | Description | Request | Response |
|--------|------|-------------|---------|----------|
| POST | /api/events | Create event | CreateEventDto | EventDto |
| PUT | /api/events/{id} | Update event | UpdateEventDto | EventDto |
| DELETE | /api/events/{id} | Delete event | - | 204 No Content |
| POST | /api/events/{id}/sessions | Add session | CreateSessionDto | EventSessionDto |
| PUT | /api/sessions/{id} | Update session | UpdateSessionDto | EventSessionDto |
| DELETE | /api/sessions/{id} | Delete session | - | 204 No Content |
| POST | /api/events/{id}/ticket-types | Create ticket type | CreateTicketTypeDto | EventTicketTypeDto |
| PUT | /api/ticket-types/{id} | Update ticket type | UpdateTicketTypeDto | EventTicketTypeDto |
| DELETE | /api/ticket-types/{id} | Delete ticket type | - | 204 No Content |

## Component Specifications

### 1. AdminDashboardPage (TO CREATE)
- **Path**: `/admin`
- **Authorization**: Administrator role required
- **Render Mode**: Standard React component
- **Purpose**: Landing page connecting to AdminEventsPage
- **Estimated Size**: 100-150 lines (simple dashboard)

**Key Features**:
- Quick stats cards (events count, drafts, upcoming)
- Action tiles grid with "Manage Events" as primary tile
- Navigation to `/admin/events`
- Reuse existing DashboardLayout component

### 2. AdminEventsPage (EXISTS ✅)
- **Path**: `/admin/events`
- **Authorization**: Administrator role required  
- **Current Status**: 568 lines, fully functional UI
- **Key Features**: Complete CRUD interface, EventForm modal, delete confirmations
- **Issue**: Calls non-existent POST/PUT/DELETE endpoints

### 3. Event Session Matrix Backend (TO IMPLEMENT)
- **Entities**: EventSession, EventTicketType, TicketTypeSessionInclusions
- **Service Methods**: CRUD operations with complex availability calculations
- **Database**: PostgreSQL with proper FK relationships
- **Validation**: Business rules for capacity, dates, sessions

### State Management (EXISTS ✅)
- **TanStack Query**: Already configured for caching and mutations
- **React Context**: Authentication context working
- **Component State**: Local state in AdminEventsPage for modals
- **API Integration**: useEvents, useCreateEvent, useUpdateEvent, useDeleteEvent hooks ready

## Integration Points

### Authentication System (EXISTS ✅)
- **Pattern**: httpOnly cookies via `/auth/login`, `/auth/logout` endpoints
- **Role Checking**: Administrator role validation in authLoader
- **Context**: React auth context provides user state

### Navigation Integration (SIMPLE ADDITION)
- **Current**: "Admin" link in Navigation exists but goes nowhere
- **Required**: Add `/admin` route pointing to AdminDashboardPage
- **Flow**: Admin link → Dashboard → "Manage Events" → AdminEventsPage

### Error Handling (EXISTS ✅)
- **Pattern**: TanStack Query error boundaries
- **Notifications**: Mantine notifications for success/error states
- **Validation**: Frontend form validation + backend API validation

## Security Requirements (EXISTING PATTERNS)

### Authentication & Authorization (WORKING ✅)
- **Admin Role Verification**: authLoader checks Administrator role
- **Session Security**: httpOnly cookie authentication
- **API Security**: CORS and request validation already configured

### Data Protection (TO IMPLEMENT)
- **Input Validation**: Sanitize event form inputs (XSS prevention)
- **SQL Injection Protection**: Use parameterized EF Core queries
- **Admin Action Auditing**: Log all CRUD operations with user ID

## Performance Requirements (EXISTING TARGETS)

### Response Time Targets
- **Admin Dashboard**: <1 second (simple page)
- **Events List**: <2 seconds (already achieved)
- **Event Creation**: <3 seconds (form submission)
- **Database Operations**: <500ms (single entity operations)

### Concurrent Users
- **Admin Users**: 5-10 concurrent (realistic for community)
- **Database Connections**: Existing connection pooling sufficient
- **Memory Usage**: Minimal increase (simple CRUD operations)

## Testing Requirements

### Unit Test Coverage
- **Backend**: 80% coverage for new CRUD operations
- **Frontend**: Test AdminDashboardPage component
- **Integration**: End-to-end admin workflow

### Existing Test Infrastructure (LEVERAGE ✅)
- **TDD Tests**: 50 tests already written in `/docs/functional-areas/events/new-work/2025-08-24-events-management/implementation/tdd-implementation-plan.md`
- **Backend Tests**: EventSessionTests.cs (22 tests for entities)
- **Integration Tests**: 8 tests for Event Session Matrix
- **React Tests**: 20 component tests for EventForm and related

### Testing Strategy
1. **Make Existing Tests Pass**: Run 50 TDD tests and implement to pass
2. **Add Dashboard Tests**: Simple component tests for AdminDashboardPage
3. **E2E Workflow**: Admin login → Dashboard → Events → Create/Edit/Delete

## Migration Requirements

### Database Migrations (TO IMPLEMENT)
```bash
# Add Event Session Matrix tables
dotnet ef migrations add AddEventSessionMatrix
dotnet ef database update
```

### Data Transformation
- **Existing Events**: Migrate to Event Session Matrix structure
- **Default Sessions**: Create default session for events without sessions
- **Backward Compatibility**: Ensure existing GET endpoints continue working

### Configuration Changes
- **Routes**: Add `/admin` route to React router
- **Permissions**: Verify Administrator role permissions
- **API Endpoints**: Register new endpoints in Program.cs

## Dependencies

### Required NuGet Packages (EXISTING ✅)
- Entity Framework Core 9 (PostgreSQL provider)
- ASP.NET Core 9 (Minimal APIs)
- AutoMapper (DTO mapping)
- FluentValidation (request validation)

### Required NPM Packages (EXISTING ✅)
- React Router v7 (navigation)
- TanStack Query (API integration)
- Mantine v7 (UI components)
- @witchcityrope/shared-types (generated types)

### External Services (EXISTING ✅)
- PostgreSQL database (localhost:5433)
- Authentication service (working)
- NSwag type generation (configured)

## Implementation Tasks

### Phase 1: Frontend Dashboard Connection (2-4 hours)
**Priority**: CRITICAL - Enables admin access

1. **Create AdminDashboardPage**
   ```typescript
   // /apps/web/src/pages/admin/AdminDashboardPage.tsx
   export const AdminDashboardPage: React.FC = () => {
     return (
       <DashboardLayout>
         <Box p="xl">
           <Title>Admin Dashboard</Title>
           {/* Stats cards */}
           {/* Action tiles with "Manage Events" primary */}
         </Box>
       </DashboardLayout>
     );
   };
   ```

2. **Add Admin Route**
   ```typescript
   // /apps/web/src/routes/router.tsx
   {
     path: "admin",
     element: <AdminDashboardPage />,
     loader: authLoader
   }
   ```

3. **Test Navigation Flow**
   - Admin link → `/admin` dashboard
   - Dashboard → "Manage Events" → `/admin/events`
   - Verify authentication and role checking

### Phase 2: Backend CRUD Endpoints (8-12 hours)
**Priority**: CRITICAL - Enables event management

1. **Event Session Matrix Entities**
   ```csharp
   // /src/WitchCityRope.Core/Entities/EventSession.cs
   public class EventSession
   {
       public Guid Id { get; private set; }
       public Guid EventId { get; private set; }
       public int SessionNumber { get; private set; }
       // Additional properties and business logic
   }
   ```

2. **Database Migration**
   ```bash
   dotnet ef migrations add AddEventSessionMatrix
   dotnet ef database update
   ```

3. **CRUD API Endpoints**
   ```csharp
   // Extend EventsManagementEndpoints.cs
   group.MapPost("/events", CreateEventAsync)
   group.MapPut("/events/{id:guid}", UpdateEventAsync)
   group.MapDelete("/events/{id:guid}", DeleteEventAsync)
   ```

4. **Service Implementation**
   ```csharp
   // Extend EventsManagementService.cs
   public async Task<(bool success, EventDto? response, string? error)> 
       CreateEventAsync(CreateEventDto dto, CancellationToken cancellationToken)
   ```

### Phase 3: Frontend Integration (4-6 hours)
**Priority**: HIGH - Completes the activation

1. **Update API Mutations**
   - Verify useCreateEvent, useUpdateEvent, useDeleteEvent work with new endpoints
   - Test form submission in AdminEventsPage
   - Verify notifications and error handling

2. **Add Event Session Management**
   - Connect EventForm session/ticket management to new APIs
   - Implement SessionFormModal and TicketTypeFormModal integration
   - Test complex event creation with sessions

3. **End-to-End Testing**
   - Admin workflow: Login → Dashboard → Events → Create → Edit → Delete
   - Verify events appear in public events list
   - Test error handling and validation

### Phase 4: Event Session Matrix (6-10 hours)
**Priority**: MEDIUM - Enhances functionality

1. **Complex Availability Calculations**
   - Multi-session capacity logic
   - Cross-ticket-type availability
   - Real-time availability updates

2. **Advanced Event Features**
   - Session-specific ticket types
   - Capacity constraints across sessions
   - RSVP vs ticket handling

## Acceptance Criteria

### Technical Criteria (Must Have)
- [ ] AdminDashboardPage renders and navigates correctly
- [ ] All CRUD endpoints functional (POST/PUT/DELETE events)
- [ ] AdminEventsPage can create/edit/delete events successfully
- [ ] Event Session Matrix database tables created and populated
- [ ] All existing GET endpoints continue working
- [ ] No TypeScript compilation errors
- [ ] Authentication and authorization working

### Business Criteria (Must Have)
- [ ] Admin can access dashboard via "Admin" navigation link
- [ ] Admin can create new events with title, description, dates
- [ ] Admin can edit existing event details
- [ ] Admin can delete events with confirmation
- [ ] Created events appear in public events listing
- [ ] Success/error notifications work properly

### Quality Criteria (Should Have)
- [ ] 50 existing TDD tests pass
- [ ] Response times under 2 seconds
- [ ] Mobile responsive design
- [ ] Accessibility compliance (WCAG AA)
- [ ] Error handling covers edge cases

## Quality Gate Checklist

### Pre-Implementation
- [x] Existing assets analyzed and documented
- [x] Missing components identified
- [x] Implementation tasks prioritized
- [x] Test strategy defined

### Phase 1 Complete
- [ ] AdminDashboardPage created and styled
- [ ] Route configuration updated
- [ ] Navigation flow tested
- [ ] Authentication working

### Phase 2 Complete
- [ ] Database migrations run successfully
- [ ] CRUD endpoints implemented
- [ ] API testing with tools (Postman/curl)
- [ ] Error handling implemented

### Phase 3 Complete
- [ ] Frontend forms submit successfully
- [ ] All mutations working with real API
- [ ] End-to-end admin workflow tested
- [ ] Public events show created events

### Ready for Production
- [ ] All acceptance criteria met
- [ ] Performance targets achieved
- [ ] Security review completed
- [ ] Documentation updated

## Risk Assessment

### Low Risk (EXISTING ASSETS)
- **AdminEventsPage**: 568 lines of working UI code
- **Authentication**: Fully functional system
- **TanStack Query**: Working API integration
- **Database**: PostgreSQL configured and working

### Medium Risk (STRAIGHTFORWARD IMPLEMENTATION)
- **AdminDashboardPage**: Simple component using existing patterns
- **Basic CRUD Endpoints**: Standard Entity Framework operations
- **Route Configuration**: Adding one route to existing router

### High Risk (COMPLEX BUSINESS LOGIC)
- **Event Session Matrix**: Complex entity relationships
- **Availability Calculations**: Multi-session capacity logic
- **Data Migration**: Existing events to new structure

### Mitigation Strategies
1. **Phase Implementation**: Start with simple dashboard, add complexity gradually
2. **Existing Test Leverage**: Use 50 TDD tests to verify implementation
3. **Incremental Testing**: Test each phase thoroughly before proceeding
4. **Rollback Plan**: Database migrations can be rolled back if needed

## Success Metrics

### Immediate Success (Phase 1-2)
- Admin can navigate: Admin link → Dashboard → Events Management
- AdminEventsPage can perform basic CRUD operations
- No broken functionality in existing system

### Full Success (Phase 3-4)
- Complete admin workflow working end-to-end
- Public events page shows admin-created events
- Event Session Matrix fully functional
- All 50 TDD tests passing

### Business Value Delivered
- **$40,000+ Investment Activated**: Existing development work becomes operational
- **Administrative Efficiency**: Digital event management vs manual processes
- **Community Growth Support**: Proper tools for Salem rope bondage community events
- **Technical Debt Reduction**: Complete implementation vs partial system

## Timeline Estimate

### Aggressive Timeline (Minimum Viable)
- **Phase 1**: 4 hours (dashboard + routing)
- **Phase 2**: 12 hours (backend CRUD)
- **Phase 3**: 6 hours (frontend integration)
- **Total**: ~22 hours (3 days)

### Conservative Timeline (Complete Implementation)
- **Phase 1**: 6 hours (dashboard + testing)
- **Phase 2**: 16 hours (backend + Event Session Matrix)
- **Phase 3**: 8 hours (frontend + testing)
- **Phase 4**: 10 hours (advanced features)
- **Total**: ~40 hours (5 days)

### Recommended Approach
Start with aggressive timeline for basic activation, then enhance with advanced features in Phase 4.

---

**ACTIVATION FOCUS**: This specification prioritizes connecting existing, high-quality components (AdminEventsPage, authentication, TanStack Query) with minimal new code to achieve operational admin events management. The goal is maximum value delivery in minimum time by leveraging substantial existing investments.