@page "/admin/events"
@using WitchCityRope.Web.Services
@inject ApiClient ApiClient
@inject NavigationManager Navigation
@attribute [Authorize(Roles = "Administrator,Admin,EventOrganizer")]
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode())

@* Event management page for administrators and organizers *@

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">Event Management</h1>
        <button class="btn btn-primary" @onclick="CreateNewEvent">
            + Create New Event
        </button>
    </div>

    <div class="admin-filters">
        <input type="text" @bind="searchTerm" @bind:event="oninput" 
               class="filter-input" placeholder="Search events..." />
        
        <select @bind="filterStatus" @bind:event="oninput" class="filter-select">
            <option value="">All Status</option>
            <option value="draft">Draft</option>
            <option value="published">Published</option>
            <option value="cancelled">Cancelled</option>
            <option value="completed">Completed</option>
        </select>

        <select @bind="filterTimeframe" @bind:event="oninput" class="filter-select">
            <option value="">All Time</option>
            <option value="upcoming">Upcoming</option>
            <option value="past">Past</option>
            <option value="thisMonth">This Month</option>
            <option value="nextMonth">Next Month</option>
        </select>
    </div>

    @if (isLoading)
    {
        <LoadingSpinner />
    }
    else
    {
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Registrations</th>
                        <th>Revenue</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var eventItem in filteredEvents)
                    {
                        <tr>
                            <td>
                                <div class="event-info">
                                    <strong>@eventItem.Title</strong>
                                    <span class="event-location">@eventItem.Location</span>
                                </div>
                            </td>
                            <td>@eventItem.StartDate.ToString("MMM d, yyyy")</td>
                            <td><span class="badge badge-@eventItem.Type">@eventItem.Type</span></td>
                            <td><span class="badge badge-@eventItem.Status">@eventItem.Status</span></td>
                            <td>
                                <div class="registration-info">
                                    <span>@eventItem.RegisteredCount / @eventItem.Capacity</span>
                                    <div class="capacity-bar">
                                        <div class="capacity-fill" style="width: @GetCapacityPercentage(eventItem)%"></div>
                                    </div>
                                </div>
                            </td>
                            <td>$@eventItem.TotalRevenue.ToString("N2")</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon" title="Edit" @onclick="() => EditEvent(eventItem.Id)">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="btn-icon" title="View Details" @onclick="() => ViewEventDetails(eventItem.Id)">
                                        üëÅÔ∏è
                                    </button>
                                    <button class="btn-icon" title="Manage Attendees" @onclick="() => ManageAttendees(eventItem.Id)">
                                        üë•
                                    </button>
                                    <button class="btn-icon" title="Duplicate" @onclick="() => DuplicateEvent(eventItem.Id)">
                                        üìã
                                    </button>
                                    @if (eventItem.Status != "cancelled")
                                    {
                                        <button class="btn-icon btn-danger" title="Cancel" @onclick="() => CancelEvent(eventItem.Id)">
                                            ‚ùå
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!filteredEvents.Any())
        {
            <div class="empty-state">
                <h3>No events found</h3>
                <p>Try adjusting your filters or create a new event.</p>
            </div>
        }
    }
</div>

@* Event Editor Modal *@
@if (showEventEditor)
{
    <div class="modal modal-visible" @onclick="CloseEventEditor">
        <div class="modal-content modal-large" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2 class="modal-title">@(editingEventId > 0 ? "Edit Event" : "Create New Event")</h2>
                <button type="button" class="modal-close" @onclick="CloseEventEditor">√ó</button>
            </div>
            
            <EditForm Model="@eventForm" OnValidSubmit="@SaveEvent" class="event-form">
                <DataAnnotationsValidator />
                
                <div class="form-row">
                    <div class="form-group form-group-wide">
                        <label class="form-label">Event Title</label>
                        <InputText @bind-Value="eventForm.Title" class="form-input" />
                        <ValidationMessage For="@(() => eventForm.Title)" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Event Type</label>
                        <InputSelect @bind-Value="eventForm.Type" class="form-input">
                            <option value="">Select Type</option>
                            <option value="workshop">Workshop</option>
                            <option value="performance">Performance</option>
                            <option value="social">Social Event</option>
                            <option value="intensive">Intensive</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => eventForm.Type)" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <InputSelect @bind-Value="eventForm.Status" class="form-input">
                            <option value="draft">Draft</option>
                            <option value="published">Published</option>
                        </InputSelect>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Date & Time</label>
                        <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="eventForm.StartDate" class="form-input" />
                        <ValidationMessage For="@(() => eventForm.StartDate)" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">End Date & Time</label>
                        <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="eventForm.EndDate" class="form-input" />
                        <ValidationMessage For="@(() => eventForm.EndDate)" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <InputTextArea @bind-Value="eventForm.Description" class="form-input" rows="5" />
                    <ValidationMessage For="@(() => eventForm.Description)" />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <InputText @bind-Value="eventForm.Location" class="form-input" />
                        <ValidationMessage For="@(() => eventForm.Location)" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Capacity</label>
                        <InputNumber @bind-Value="eventForm.Capacity" class="form-input" />
                        <ValidationMessage For="@(() => eventForm.Capacity)" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Price ($)</label>
                        <InputNumber @bind-Value="eventForm.Price" class="form-input" />
                        <ValidationMessage For="@(() => eventForm.Price)" />
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" @onclick="CloseEventEditor">Cancel</button>
                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Event</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<EventManagementViewModel> events = new();
    private List<EventManagementViewModel> filteredEvents = new();
    private bool isLoading = true;
    private bool showEventEditor = false;
    private bool isSaving = false;
    private int editingEventId = 0;

    // Filters
    private string searchTerm = "";
    private string filterStatus = "";
    private string filterTimeframe = "";

    // Event form model
    private EventFormModel eventForm = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadEvents();
    }

    private async Task LoadEvents()
    {
        try
        {
            isLoading = true;
            events = await ApiClient.GetManagedEventsAsync();
            ApplyFilters();
        }
        catch (Exception)
        {
            // TODO: Handle error
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        filteredEvents = events.Where(e =>
            (string.IsNullOrEmpty(searchTerm) || 
             e.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
             e.Location.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrEmpty(filterStatus) || e.Status == filterStatus) &&
            ApplyTimeframeFilter(e)
        ).ToList();
    }

    private bool ApplyTimeframeFilter(EventManagementViewModel e)
    {
        if (string.IsNullOrEmpty(filterTimeframe)) return true;
        
        var now = DateTime.Now;
        return filterTimeframe switch
        {
            "upcoming" => e.StartDate >= now,
            "past" => e.StartDate < now,
            "thisMonth" => e.StartDate.Month == now.Month && e.StartDate.Year == now.Year,
            "nextMonth" => e.StartDate.Month == now.AddMonths(1).Month && e.StartDate.Year == now.AddMonths(1).Year,
            _ => true
        };
    }

    private double GetCapacityPercentage(EventManagementViewModel e)
    {
        if (e.Capacity == 0) return 0;
        return (double)e.RegisteredCount / e.Capacity * 100;
    }

    private void CreateNewEvent()
    {
        editingEventId = 0;
        eventForm = new EventFormModel
        {
            StartDate = DateTime.Now.AddDays(7).Date.AddHours(19),
            EndDate = DateTime.Now.AddDays(7).Date.AddHours(21)
        };
        showEventEditor = true;
    }

    private async Task EditEvent(int eventId)
    {
        var eventToEdit = events.FirstOrDefault(e => e.Id == eventId);
        if (eventToEdit != null)
        {
            editingEventId = eventId;
            eventForm = new EventFormModel
            {
                Title = eventToEdit.Title,
                Type = eventToEdit.Type,
                Status = eventToEdit.Status,
                StartDate = eventToEdit.StartDate,
                EndDate = eventToEdit.EndDate,
                Description = eventToEdit.Description ?? "",
                Location = eventToEdit.Location,
                Capacity = eventToEdit.Capacity,
                Price = eventToEdit.Price
            };
            showEventEditor = true;
        }
    }

    private void CloseEventEditor()
    {
        showEventEditor = false;
        editingEventId = 0;
        eventForm = new();
    }

    private async Task SaveEvent()
    {
        try
        {
            isSaving = true;
            if (editingEventId > 0)
            {
                await ApiClient.UpdateEventAsync(editingEventId, eventForm);
            }
            else
            {
                await ApiClient.CreateEventAsync(eventForm);
            }
            
            await LoadEvents();
            CloseEventEditor();
        }
        catch (Exception)
        {
            // TODO: Handle error
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ViewEventDetails(int eventId)
    {
        Navigation.NavigateTo($"/events/{eventId}", forceLoad: true);
    }

    private void ManageAttendees(int eventId)
    {
        Navigation.NavigateTo($"/admin/events/{eventId}/attendees", forceLoad: true);
    }

    private async Task DuplicateEvent(int eventId)
    {
        // TODO: Implement event duplication
    }

    private async Task CancelEvent(int eventId)
    {
        // TODO: Implement event cancellation with confirmation
    }

    // View models
}