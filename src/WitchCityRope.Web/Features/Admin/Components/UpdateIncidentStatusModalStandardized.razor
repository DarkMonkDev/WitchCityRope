@using WitchCityRope.Web.Shared.Validation.Components
@using System.ComponentModel.DataAnnotations

@if (IsVisible && Incident != null)
{
    <div class="modal modal-visible" @onclick="CloseModal">
        <div class="modal-content modal-small" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2 class="modal-title">Update Incident Status</h2>
                <button type="button" class="modal-close" @onclick="CloseModal">Ã—</button>
            </div>
            
            <EditForm Model="StatusForm" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                
                <div class="modal-body">
                    <div class="current-status">
                        <label>Current Status:</label>
                        <span class="status-badge status-@Incident.Status.ToLower().Replace(' ', '-')">
                            @Incident.Status
                        </span>
                    </div>

                    <WcrInputSelect @bind-Value="StatusForm.NewStatus" 
                                    Label="New Status"
                                    IsRequired="true">
                        <option value="">Select new status</option>
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Closed">Closed</option>
                    </WcrInputSelect>

                    <WcrInputTextArea @bind-Value="StatusForm.Note" 
                                      Label="Note (optional)"
                                      Placeholder="Add any relevant notes about this status change..."
                                      Rows="4" />

                    <WcrValidationSummary />
                </div>

                <div class="modal-actions">
                    <button type="submit" class="wcr-button wcr-button-primary" disabled="@IsProcessing">
                        @if (IsProcessing)
                        {
                            <span class="spinner-border spinner-border-sm mr-2"></span>
                            <span>Updating...</span>
                        }
                        else
                        {
                            <span>Update Status</span>
                        }
                    </button>
                    <button type="button" class="wcr-button wcr-button-secondary" @onclick="CloseModal">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
}

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
        opacity: 0;
        animation: fadeIn 0.3s forwards;
    }

    .modal-visible {
        opacity: 1;
    }

    .modal-content {
        background: white;
        border-radius: var(--wcr-radius-lg);
        box-shadow: var(--wcr-shadow-xl);
        max-width: 90%;
        max-height: 90vh;
        overflow: auto;
        transform: scale(0.9);
        animation: scaleIn 0.3s forwards;
    }

    .modal-small {
        width: 500px;
    }

    .modal-header {
        padding: var(--wcr-space-lg);
        border-bottom: 1px solid var(--wcr-color-taupe);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--wcr-color-cream);
        border-radius: var(--wcr-radius-lg) var(--wcr-radius-lg) 0 0;
    }

    .modal-title {
        margin: 0;
        font-family: var(--wcr-font-heading);
        font-size: 24px;
        color: var(--wcr-color-burgundy);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        line-height: 1;
        color: var(--wcr-color-stone);
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--wcr-radius-sm);
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: var(--wcr-color-burgundy);
        color: white;
    }

    .modal-body {
        padding: var(--wcr-space-xl);
    }

    .current-status {
        display: flex;
        align-items: center;
        gap: var(--wcr-space-md);
        margin-bottom: var(--wcr-space-xl);
        padding: var(--wcr-space-md);
        background: var(--wcr-color-cream);
        border-radius: var(--wcr-radius-md);
    }

    .current-status label {
        font-weight: 600;
        color: var(--wcr-color-charcoal);
    }

    .status-badge {
        padding: var(--wcr-space-xs) var(--wcr-space-sm);
        border-radius: var(--wcr-radius-sm);
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-badge.status-open {
        background: #ffc107;
        color: #000;
    }

    .status-badge.status-in-progress {
        background: #17a2b8;
        color: white;
    }

    .status-badge.status-resolved {
        background: #28a745;
        color: white;
    }

    .status-badge.status-closed {
        background: #6c757d;
        color: white;
    }

    .modal-actions {
        padding: var(--wcr-space-lg) var(--wcr-space-xl);
        border-top: 1px solid var(--wcr-color-taupe);
        display: flex;
        gap: var(--wcr-space-md);
        justify-content: flex-end;
        background: var(--wcr-color-cream);
        border-radius: 0 0 var(--wcr-radius-lg) var(--wcr-radius-lg);
    }

    .wcr-button {
        display: inline-flex;
        align-items: center;
        gap: var(--wcr-space-sm);
        padding: var(--wcr-space-sm) var(--wcr-space-lg);
        border: none;
        border-radius: var(--wcr-radius-sm);
        font-family: var(--wcr-font-heading);
        font-weight: 600;
        font-size: 16px;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .wcr-button-primary {
        background: var(--wcr-color-burgundy);
        color: white;
    }

    .wcr-button-primary:hover:not(:disabled) {
        background: var(--wcr-color-burgundy-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
    }

    .wcr-button-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .wcr-button-secondary {
        background: transparent;
        color: var(--wcr-color-stone);
        border: 2px solid var(--wcr-color-taupe);
    }

    .wcr-button-secondary:hover {
        background: var(--wcr-color-taupe);
        color: white;
    }

    .spinner-border {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        vertical-align: text-bottom;
        border: 0.15em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border 0.75s linear infinite;
    }

    @@keyframes fadeIn {
        to { opacity: 1; }
    }

    @@keyframes scaleIn {
        to { transform: scale(1); }
    }

    @@keyframes spinner-border {
        to { transform: rotate(360deg); }
    }
</style>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public IncidentViewModel? Incident { get; set; }
    [Parameter] public EventCallback<StatusUpdateModel> OnStatusUpdated { get; set; }

    private StatusUpdateFormModel StatusForm = new();
    private bool IsProcessing = false;

    protected override void OnParametersSet()
    {
        if (IsVisible && Incident != null)
        {
            // Initialize form
            StatusForm = new StatusUpdateFormModel
            {
                CurrentStatus = Incident.Status
            };
        }
    }

    private async Task HandleSubmit()
    {
        if (StatusForm.NewStatus == Incident?.Status)
        {
            // No change in status
            await CloseModal();
            return;
        }

        IsProcessing = true;
        StateHasChanged();

        try
        {
            var updateModel = new StatusUpdateModel
            {
                IncidentId = Incident!.Id,
                NewStatus = StatusForm.NewStatus,
                Note = StatusForm.Note
            };

            await OnStatusUpdated.InvokeAsync(updateModel);
            await CloseModal();
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    private async Task CloseModal()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
    }

    public class StatusUpdateFormModel
    {
        public string CurrentStatus { get; set; } = "";
        
        [Required(ErrorMessage = "Please select a new status")]
        public string NewStatus { get; set; } = "";
        
        [StringLength(500, ErrorMessage = "Note must not exceed 500 characters")]
        public string? Note { get; set; }
    }

    public class StatusUpdateModel
    {
        public int IncidentId { get; set; }
        public string NewStatus { get; set; } = "";
        public string? Note { get; set; }
    }

    public class IncidentViewModel
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string Status { get; set; } = "";
    }
}